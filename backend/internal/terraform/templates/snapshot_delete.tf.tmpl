# ============================================================================
# EBS Snapshot Deletion (Old/Unused)
# ============================================================================
# Recommendation ID: {{.RecommendationID}}
# Snapshot: {{.SnapshotID}}
# Monthly savings: ${{printf "%.2f" .MonthlySavings}}
#
# WARNING: IRREVERSIBLE! Ensure no AMIs depend on this snapshot.
# ============================================================================

resource "null_resource" "delete_snapshot_{{.ResourceName}}" {
  provisioner "local-exec" {
    command = <<-EOT
      SNAPSHOT_STATE=$(aws ec2 describe-snapshots --snapshot-ids {{.SnapshotID}} --region {{.Region}} --query 'Snapshots[0].State' --output text 2>/dev/null || echo "not-found")
      if [ "$SNAPSHOT_STATE" = "completed" ]; then
        aws ec2 delete-snapshot --snapshot-id {{.SnapshotID}} --region {{.Region}}
        echo "Snapshot deleted"
      else
        echo "Snapshot not found or not completed"
      fi
    EOT
  }
  triggers = { snapshot_id = "{{.SnapshotID}}" }
}
