package rules
import("fmt";rec"github.com/finopsmind/backend/internal/recommendations")
type GP2ToGP3Rule struct{BaseRule}
func NewGP2ToGP3Rule()*GP2ToGP3Rule{return&GP2ToGP3Rule{BaseRule:BaseRule{id:"gp2-to-gp3",name:"Upgrade GP2 to GP3 EBS Volumes",description:"gp2 volumes that save 20% by upgrading to gp3",resourceTypes:[]string{"aws_ebs_volume"}}}}
func(r*GP2ToGP3Rule)Evaluate(ctx*rec.RuleContext)([]rec.Recommendation,error){q:=`SELECT v.volume_id,v.arn,v.account_id,v.region,v.size_gb FROM ebs_volumes v WHERE v.volume_type='gp2'AND v.state IN('available','in-use')`;rows,err:=ctx.DB.Query(q);if err!=nil{return nil,err};defer rows.Close();var recs[]rec.Recommendation;for rows.Next(){var id,arn,acct,region string;var sizeGB int;if err:=rows.Scan(&id,&arn,&acct,&region,&sizeGB);err!=nil{continue};savings:=float64(sizeGB)*0.10-float64(sizeGB)*0.08;if savings<=0{continue};r:=newRec(r.id,id,"ebs_volume",arn,acct,region,rec.TypeMissingOptimization,fmt.Sprintf("gp2 volume %s (%dGB)",id,sizeGB),"Upgrade to gp3 for 20% savings",savings,rec.ConfidenceHigh);r.TerraformCode=fmt.Sprintf("# Upgrade to gp3: %s\n# aws ec2 modify-volume --volume-id %s --volume-type gp3 --iops 3000 --throughput 125",id,id);recs=append(recs,r)};return recs,rows.Err()}
