package rules
import("fmt";rec"github.com/finopsmind/backend/internal/recommendations")
type CloudWatchRetentionRule struct{BaseRule;MinLogSizeGB float64}
func NewCloudWatchRetentionRule()*CloudWatchRetentionRule{return&CloudWatchRetentionRule{BaseRule:BaseRule{id:"cloudwatch-retention",name:"CloudWatch Logs Without Retention",description:"Log groups without retention policies",resourceTypes:[]string{"aws_cloudwatch_log_group"}},MinLogSizeGB:1.0}}
func(r*CloudWatchRetentionRule)Evaluate(ctx*rec.RuleContext)([]rec.Recommendation,error){q:=`SELECT l.log_group_name,l.arn,l.account_id,l.region,l.stored_bytes FROM cloudwatch_log_groups l WHERE(l.retention_days IS NULL OR l.retention_days=0)AND l.stored_bytes>$1`;rows,err:=ctx.DB.Query(q,int64(r.MinLogSizeGB*1024*1024*1024));if err!=nil{return nil,err};defer rows.Close();var recs[]rec.Recommendation;for rows.Next(){var name,arn,acct,region string;var storedBytes int64;if err:=rows.Scan(&name,&arn,&acct,&region,&storedBytes);err!=nil{continue};storedGB:=float64(storedBytes)/(1024*1024*1024);savings:=storedGB*0.03*0.9;r:=newRec(r.id,name,"cloudwatch_log_group",arn,acct,region,rec.TypeRetentionCleanup,fmt.Sprintf("Log group '%s' has %.1fGB with no retention",name,storedGB),"Set retention policy (30-90 days recommended)",savings,rec.ConfidenceHigh);r.TerraformCode=fmt.Sprintf("# Set retention: %s\nresource \"aws_cloudwatch_log_group\" \"with_retention\" {\n  name = \"%s\"\n  retention_in_days = 30\n}",name,name);recs=append(recs,r)};return recs,rows.Err()}
