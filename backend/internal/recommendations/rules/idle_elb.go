package rules
import("fmt";rec"github.com/finopsmind/backend/internal/recommendations")
type IdleELBRule struct{BaseRule;RequestThreshold int;LookbackDays int}
func NewIdleELBRule()*IdleELBRule{return&IdleELBRule{BaseRule:BaseRule{id:"idle-elb",name:"Idle Load Balancers",description:"ALB/NLB/CLB with zero requests over 7 days",resourceTypes:[]string{"aws_lb","aws_elb"}},RequestThreshold:100,LookbackDays:7}}
func(r*IdleELBRule)Evaluate(ctx*rec.RuleContext)([]rec.Recommendation,error){q:=fmt.Sprintf(`SELECT lb.name,lb.arn,lb.type,lb.account_id,lb.region,COALESCE(m.total_requests,0)FROM load_balancers lb LEFT JOIN(SELECT resource_id,SUM(value)total_requests FROM cloudwatch_metrics WHERE metric_name IN('RequestCount','ProcessedBytes')AND timestamp>NOW()-INTERVAL'%d days'GROUP BY resource_id)m ON lb.arn=m.resource_id WHERE lb.state='active'AND COALESCE(m.total_requests,0)<$1`,r.LookbackDays);rows,err:=ctx.DB.Query(q,r.RequestThreshold);if err!=nil{return nil,err};defer rows.Close();var recs[]rec.Recommendation;for rows.Next(){var name,arn,lbType,acct,region string;var totalReq float64;if err:=rows.Scan(&name,&arn,&lbType,&acct,&region,&totalReq);err!=nil{continue};r:=newRec(r.id,name,"load_balancer",arn,acct,region,rec.TypeIdleResource,fmt.Sprintf("%s '%s' with %.0f requests in %d days",lbType,name,totalReq,r.LookbackDays),"Delete unused load balancer",22.0,rec.ConfidenceHigh);recs=append(recs,r)};return recs,rows.Err()}
