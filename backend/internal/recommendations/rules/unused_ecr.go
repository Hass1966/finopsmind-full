package rules
import("fmt";"time";rec"github.com/finopsmind/backend/internal/recommendations")
type UnusedECRRule struct{BaseRule;DaysSinceLastPull int}
func NewUnusedECRRule()*UnusedECRRule{return&UnusedECRRule{BaseRule:BaseRule{id:"unused-ecr",name:"Unused ECR Images",description:"ECR images not pulled in 90+ days",resourceTypes:[]string{"aws_ecr_repository"}},DaysSinceLastPull:90}}
func(r*UnusedECRRule)Evaluate(ctx*rec.RuleContext)([]rec.Recommendation,error){q:=fmt.Sprintf(`SELECT e.repository_name,e.arn,e.account_id,e.region,e.image_count,e.total_size_bytes,e.last_image_pull FROM ecr_repositories e WHERE e.last_image_pull<NOW()-INTERVAL'%d days'OR e.last_image_pull IS NULL`,r.DaysSinceLastPull);rows,err:=ctx.DB.Query(q);if err!=nil{return nil,err};defer rows.Close();var recs[]rec.Recommendation;for rows.Next(){var name,arn,acct,region string;var imgCount int;var sizeBytes int64;var lastPull*time.Time;if err:=rows.Scan(&name,&arn,&acct,&region,&imgCount,&sizeBytes,&lastPull);err!=nil{continue};sizeGB:=float64(sizeBytes)/(1024*1024*1024);cost:=sizeGB*0.10;if cost<1{continue};lastPullInfo:="never";if lastPull!=nil{lastPullInfo=fmt.Sprintf("%d days ago",int(time.Since(*lastPull).Hours()/24))};r:=newRec(r.id,name,"ecr_repository",arn,acct,region,rec.TypeRetentionCleanup,fmt.Sprintf("ECR '%s' (%d images, %.1fGB) last pulled %s",name,imgCount,sizeGB,lastPullInfo),"Add lifecycle policy or delete unused repo",cost,rec.ConfidenceMedium);recs=append(recs,r)};return recs,rows.Err()}
