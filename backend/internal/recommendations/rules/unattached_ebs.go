package rules
import("fmt";rec"github.com/finopsmind/backend/internal/recommendations")
type UnattachedEBSRule struct{BaseRule;MinDaysUnattached int}
func NewUnattachedEBSRule()*UnattachedEBSRule{return&UnattachedEBSRule{BaseRule:BaseRule{id:"unattached-ebs",name:"Unattached EBS Volumes",description:"EBS volumes in available state",resourceTypes:[]string{"aws_ebs_volume"}},MinDaysUnattached:7}}
func(r*UnattachedEBSRule)Evaluate(ctx*rec.RuleContext)([]rec.Recommendation,error){q:=fmt.Sprintf(`SELECT v.volume_id,v.arn,v.account_id,v.region,v.volume_type,v.size_gb FROM ebs_volumes v WHERE v.state='available'AND v.created_at<NOW()-INTERVAL'%d days'`,r.MinDaysUnattached);rows,err:=ctx.DB.Query(q);if err!=nil{return nil,err};defer rows.Close();var recs[]rec.Recommendation;for rows.Next(){var id,arn,acct,region,vType string;var sizeGB int;if err:=rows.Scan(&id,&arn,&acct,&region,&vType,&sizeGB);err!=nil{continue};cost:=float64(sizeGB)*0.10;if vType=="gp3"{cost=float64(sizeGB)*0.08};r:=newRec(r.id,id,"ebs_volume",arn,acct,region,rec.TypeUnattachedResource,fmt.Sprintf("Unattached %s volume (%dGB)",vType,sizeGB),"Snapshot and delete volume",cost,rec.ConfidenceHigh);r.TerraformCode=fmt.Sprintf("# Delete unattached EBS: %s\n# aws ec2 create-snapshot --volume-id %s\n# aws ec2 delete-volume --volume-id %s",id,id,id);recs=append(recs,r)};return recs,rows.Err()}
