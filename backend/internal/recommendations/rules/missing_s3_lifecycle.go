package rules
import("fmt";rec"github.com/finopsmind/backend/internal/recommendations")
type MissingS3LifecycleRule struct{BaseRule;MinBucketSizeGB float64}
func NewMissingS3LifecycleRule()*MissingS3LifecycleRule{return&MissingS3LifecycleRule{BaseRule:BaseRule{id:"missing-s3-lifecycle",name:"S3 Buckets Without Lifecycle Policies",description:"Large S3 buckets (>100GB) without lifecycle rules",resourceTypes:[]string{"aws_s3_bucket"}},MinBucketSizeGB:100.0}}
func(r*MissingS3LifecycleRule)Evaluate(ctx*rec.RuleContext)([]rec.Recommendation,error){q:=`SELECT b.bucket_name,b.arn,b.account_id,b.region,b.size_bytes,b.object_count FROM s3_buckets b WHERE b.has_lifecycle_rules=false AND b.size_bytes>$1`;rows,err:=ctx.DB.Query(q,int64(r.MinBucketSizeGB*1024*1024*1024));if err!=nil{return nil,err};defer rows.Close();var recs[]rec.Recommendation;for rows.Next(){var name,arn,acct,region string;var sizeBytes int64;var objCount int;if err:=rows.Scan(&name,&arn,&acct,&region,&sizeBytes,&objCount);err!=nil{continue};sizeGB:=float64(sizeBytes)/(1024*1024*1024);savings:=sizeGB*0.3*(0.023-0.0125);r:=newRec(r.id,name,"s3_bucket",arn,acct,region,rec.TypeMissingOptimization,fmt.Sprintf("Bucket '%s' has %.1fGB without lifecycle rules",name,sizeGB),"Add lifecycle policy for automatic tiering",savings,rec.ConfidenceMedium);r.TerraformCode=fmt.Sprintf("# Add lifecycle to S3: %s\nresource \"aws_s3_bucket_lifecycle_configuration\" \"lifecycle\" {\n  bucket = \"%s\"\n  rule {\n    id = \"transition-to-ia\"\n    status = \"Enabled\"\n    transition { days = 30; storage_class = \"STANDARD_IA\" }\n  }\n}",name,name);recs=append(recs,r)};return recs,rows.Err()}
