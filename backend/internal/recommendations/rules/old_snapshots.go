package rules
import("fmt";"time";rec"github.com/finopsmind/backend/internal/recommendations")
type OldSnapshotsRule struct{BaseRule;RetentionDays int}
func NewOldSnapshotsRule()*OldSnapshotsRule{return&OldSnapshotsRule{BaseRule:BaseRule{id:"old-snapshots",name:"Old EBS Snapshots",description:"EBS snapshots older than 90 days",resourceTypes:[]string{"aws_ebs_snapshot"}},RetentionDays:90}}
func(r*OldSnapshotsRule)Evaluate(ctx*rec.RuleContext)([]rec.Recommendation,error){q:=fmt.Sprintf(`SELECT s.snapshot_id,s.volume_id,s.arn,s.account_id,s.region,s.volume_size_gb,s.start_time,v.state FROM ebs_snapshots s LEFT JOIN ebs_volumes v ON s.volume_id=v.volume_id WHERE s.state='completed'AND s.start_time<NOW()-INTERVAL'%d days'ORDER BY s.volume_size_gb DESC`,r.RetentionDays);rows,err:=ctx.DB.Query(q);if err!=nil{return nil,err};defer rows.Close();var recs[]rec.Recommendation;for rows.Next(){var snapID,volID,arn,acct,region string;var sizeGB int;var startTime time.Time;var volState*string;if err:=rows.Scan(&snapID,&volID,&arn,&acct,&region,&sizeGB,&startTime,&volState);err!=nil{continue};ageInDays:=int(time.Since(startTime).Hours()/24);cost:=float64(sizeGB)*0.05;volStatus:="deleted";if volState!=nil{volStatus=*volState};conf:=rec.ConfidenceMedium;if volStatus=="deleted"{conf=rec.ConfidenceHigh};r:=newRec(r.id,snapID,"ebs_snapshot",arn,acct,region,rec.TypeRetentionCleanup,fmt.Sprintf("Snapshot %dGB, %d days old, volume %s",sizeGB,ageInDays,volStatus),"Delete snapshot if not needed",cost,conf);r.TerraformCode=fmt.Sprintf("# Delete old snapshot: %s\n# aws ec2 delete-snapshot --snapshot-id %s",snapID,snapID);recs=append(recs,r)};return recs,rows.Err()}
