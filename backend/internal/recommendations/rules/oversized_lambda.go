package rules
import("fmt";rec"github.com/finopsmind/backend/internal/recommendations")
type OversizedLambdaRule struct{BaseRule;MemoryUsageThreshold float64;LookbackDays int}
func NewOversizedLambdaRule()*OversizedLambdaRule{return&OversizedLambdaRule{BaseRule:BaseRule{id:"oversized-lambda",name:"Oversized Lambda Functions",description:"Lambda using <50% of allocated memory",resourceTypes:[]string{"aws_lambda_function"}},MemoryUsageThreshold:50.0,LookbackDays:14}}
func(r*OversizedLambdaRule)Evaluate(ctx*rec.RuleContext)([]rec.Recommendation,error){q:=fmt.Sprintf(`SELECT l.function_name,l.arn,l.account_id,l.region,l.memory_size,COALESCE(m.max_mem,0),COALESCE(m.invocations,0),COALESCE(m.avg_dur,0)FROM lambda_functions l LEFT JOIN(SELECT resource_id,MAX(CASE WHEN metric_name='MemoryUtilization'THEN value END)max_mem,SUM(CASE WHEN metric_name='Invocations'THEN value END)invocations,AVG(CASE WHEN metric_name='Duration'THEN value END)avg_dur FROM cloudwatch_metrics WHERE metric_name IN('MemoryUtilization','Invocations','Duration')AND timestamp>NOW()-INTERVAL'%d days'GROUP BY resource_id)m ON l.function_name=m.resource_id WHERE COALESCE(m.invocations,0)>100 AND COALESCE(m.max_mem,0)<$1 AND l.memory_size>128`,r.LookbackDays);rows,err:=ctx.DB.Query(q,r.MemoryUsageThreshold);if err!=nil{return nil,err};defer rows.Close();var recs[]rec.Recommendation;for rows.Next(){var name,arn,acct,region string;var memSize int;var maxMem,invocations,avgDur float64;if err:=rows.Scan(&name,&arn,&acct,&region,&memSize,&maxMem,&invocations,&avgDur);err!=nil{continue};recMB:=int((maxMem*float64(memSize)/100.0+63)/64)*64;if recMB<128{recMB=128};if recMB>=memSize{continue};curCost:=(float64(memSize)/1024.0)*(avgDur/1000.0)*invocations*0.0000166667*30;newCost:=(float64(recMB)/1024.0)*(avgDur/1000.0)*invocations*0.0000166667*30;savings:=curCost-newCost;if savings<1{continue};r:=newRec(r.id,name,"lambda_function",arn,acct,region,rec.TypeOversized,fmt.Sprintf("Lambda %dMB allocated, %.1f%% used",memSize,maxMem),fmt.Sprintf("Reduce memory to %dMB",recMB),savings,rec.ConfidenceMedium);recs=append(recs,r)};return recs,rows.Err()}
