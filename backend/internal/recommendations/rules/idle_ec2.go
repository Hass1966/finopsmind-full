package rules
import("fmt";rec"github.com/finopsmind/backend/internal/recommendations")
type IdleEC2Rule struct{BaseRule;CPUThreshold float64;LookbackDays int}
func NewIdleEC2Rule()*IdleEC2Rule{return&IdleEC2Rule{BaseRule:BaseRule{id:"idle-ec2",name:"Idle EC2 Instances",description:"EC2 with <5% CPU for 14 days",resourceTypes:[]string{"aws_ec2_instance"}},CPUThreshold:5.0,LookbackDays:14}}
func(r*IdleEC2Rule)Evaluate(ctx*rec.RuleContext)([]rec.Recommendation,error){q:=fmt.Sprintf(`SELECT i.instance_id,i.instance_type,i.arn,i.account_id,i.region,COALESCE(m.avg_cpu,0),COALESCE(m.max_cpu,0)FROM ec2_instances i LEFT JOIN(SELECT resource_id,AVG(value)avg_cpu,MAX(value)max_cpu FROM cloudwatch_metrics WHERE metric_name='CPUUtilization'AND timestamp>NOW()-INTERVAL'%d days'GROUP BY resource_id)m ON i.instance_id=m.resource_id WHERE i.state='running'AND COALESCE(m.avg_cpu,0)<$1`,r.LookbackDays);rows,err:=ctx.DB.Query(q,r.CPUThreshold);if err!=nil{return nil,err};defer rows.Close();var recs[]rec.Recommendation;for rows.Next(){var id,itype,arn,acct,region string;var avgCPU,maxCPU float64;if err:=rows.Scan(&id,&itype,&arn,&acct,&region,&avgCPU,&maxCPU);err!=nil{continue};price,_:=ctx.PricingData.GetEC2HourlyPrice(itype,region);if price==0{price=0.10};conf:=rec.ConfidenceHigh;if maxCPU>20{conf=rec.ConfidenceMedium};r:=newRec(r.id,id,"ec2_instance",arn,acct,region,rec.TypeIdleResource,fmt.Sprintf("Running %s with %.1f%% avg CPU",itype,avgCPU),"Stop or terminate instance",price*hoursPerMonth,conf);r.TerraformCode=fmt.Sprintf("# Stop idle EC2: %s\n# aws ec2 stop-instances --instance-ids %s",id,id);recs=append(recs,r)};return recs,rows.Err()}
