package rules
import("fmt";rec"github.com/finopsmind/backend/internal/recommendations")
type MissingS3TieringRule struct{BaseRule;MinBucketSizeGB float64}
func NewMissingS3TieringRule()*MissingS3TieringRule{return&MissingS3TieringRule{BaseRule:BaseRule{id:"missing-s3-tiering",name:"S3 Without Intelligent-Tiering",description:"Buckets that could use Intelligent-Tiering",resourceTypes:[]string{"aws_s3_bucket"}},MinBucketSizeGB:50.0}}
func(r*MissingS3TieringRule)Evaluate(ctx*rec.RuleContext)([]rec.Recommendation,error){q:=`SELECT b.bucket_name,b.arn,b.account_id,b.region,b.size_bytes FROM s3_buckets b WHERE b.primary_storage_class='STANDARD'AND b.size_bytes>$1`;rows,err:=ctx.DB.Query(q,int64(r.MinBucketSizeGB*1024*1024*1024));if err!=nil{return nil,err};defer rows.Close();var recs[]rec.Recommendation;for rows.Next(){var name,arn,acct,region string;var sizeBytes int64;if err:=rows.Scan(&name,&arn,&acct,&region,&sizeBytes);err!=nil{continue};sizeGB:=float64(sizeBytes)/(1024*1024*1024);savings:=sizeGB*0.023*0.20;r:=newRec(r.id,name,"s3_bucket",arn,acct,region,rec.TypeMissingOptimization,fmt.Sprintf("Bucket '%s' (%.1fGB) without Intelligent-Tiering",name,sizeGB),"Enable Intelligent-Tiering",savings,rec.ConfidenceLow);recs=append(recs,r)};return recs,rows.Err()}
