package rules
import("fmt";rec"github.com/finopsmind/backend/internal/recommendations")
type MultiAZDevRule struct{BaseRule;DevEnvTags[]string}
func NewMultiAZDevRule()*MultiAZDevRule{return&MultiAZDevRule{BaseRule:BaseRule{id:"multi-az-dev",name:"Multi-AZ on Dev/Test RDS",description:"Dev/test RDS with Multi-AZ enabled",resourceTypes:[]string{"aws_rds_instance"}},DevEnvTags:[]string{"dev","development","test","staging","qa","sandbox"}}}
func(r*MultiAZDevRule)Evaluate(ctx*rec.RuleContext)([]rec.Recommendation,error){q:=`SELECT d.db_instance_id,d.db_instance_class,d.engine,d.arn,d.account_id,d.region,d.tags->>'Environment'FROM rds_instances d WHERE d.multi_az=true AND d.status='available'AND(LOWER(d.tags->>'Environment')SIMILAR TO'%(dev|test|staging|qa|sandbox)%'OR LOWER(d.tags->>'Name')SIMILAR TO'%(dev|test|staging|qa|sandbox)%'OR LOWER(d.db_instance_id)SIMILAR TO'%(dev|test|staging|qa|sandbox)%')`;rows,err:=ctx.DB.Query(q);if err!=nil{return nil,err};defer rows.Close();var recs[]rec.Recommendation;for rows.Next(){var id,class,engine,arn,acct,region string;var envTag*string;if err:=rows.Scan(&id,&class,&engine,&arn,&acct,&region,&envTag);err!=nil{continue};singleAZPrice,_:=ctx.PricingData.GetRDSHourlyPrice(class,engine,region,false);multiAZPrice,_:=ctx.PricingData.GetRDSHourlyPrice(class,engine,region,true);if singleAZPrice==0{singleAZPrice=0.10};if multiAZPrice==0{multiAZPrice=singleAZPrice*2};savings:=(multiAZPrice-singleAZPrice)*hoursPerMonth;env:="dev/test";if envTag!=nil{env=*envTag};r:=newRec(r.id,id,"rds_instance",arn,acct,region,rec.TypeMissingOptimization,fmt.Sprintf("Dev/test RDS '%s' (%s, %s) has Multi-AZ",id,class,env),"Disable Multi-AZ for non-production",savings,rec.ConfidenceHigh);r.TerraformCode=fmt.Sprintf("# Disable Multi-AZ: %s\n# aws rds modify-db-instance --db-instance-identifier %s --no-multi-az",id,id);recs=append(recs,r)};return recs,rows.Err()}
